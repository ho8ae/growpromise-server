name: Deploy GrowPromise API

on:
  push:
    branches: [ main ]
    paths:
      - 'api-server/**'
      - 'docker-compose.yml'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]

env:
  PROJECT_NAME: growpromise-project

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: api-server/package-lock.json
    
    - name: Install dependencies
      working-directory: ./api-server
      run: npm ci
    
    - name: Generate Prisma client
      working-directory: ./api-server
      run: npx prisma generate
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
    
    - name: Run database migrations
      working-directory: ./api-server
      run: npx prisma migrate deploy
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
    
    - name: Run tests
      working-directory: ./api-server
      run: npm test
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        JWT_SECRET: test-secret
    
    - name: Run type check
      working-directory: ./api-server
      run: npm run type-check
    
    - name: Run linting
      working-directory: ./api-server
      run: npm run lint

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        port: 22
        script: |
          echo "ğŸš€ Starting deployment..."
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì´ë™/ìƒì„±
          cd ~ && mkdir -p ${{ env.PROJECT_NAME }}
          cd ${{ env.PROJECT_NAME }}
          
          # Git ì €ì¥ì†Œ ì´ˆê¸°í™” ë˜ëŠ” ì—…ë°ì´íŠ¸
          if [ ! -d ".git" ]; then
            echo "ğŸ“¥ Cloning repository..."
            git clone ${{ github.server_url }}/${{ github.repository }} .
          else
            echo "ğŸ”„ Updating repository..."
            git fetch origin
            git reset --hard origin/main
          fi
          
          # Docker ë„¤íŠ¸ì›Œí¬ ìƒì„± (ì—†ìœ¼ë©´)
          docker network create growpromise-network 2>/dev/null || echo "Network already exists"
          
          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ í™•ì¸
          if [ ! -f ".env" ]; then
            echo "âš ï¸ Creating .env file..."
            cat > .env << 'EOF'
          DATABASE_URL=postgresql://growpromise:${{ secrets.DB_PASSWORD }}@postgres:5432/growpromise_db
          POSTGRES_DB=growpromise_db
          POSTGRES_USER=growpromise
          POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          NODE_ENV=production
          EOF
          fi
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
          echo "ğŸ”„ Stopping existing containers..."
          docker-compose down --remove-orphans 2>/dev/null || true
          
          # ìƒˆ ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì‹œì‘
          echo "ğŸ—ï¸ Building and starting containers..."
          docker-compose up -d --build
          
          # ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜
          echo "ğŸ—„ï¸ Running database migrations..."
          sleep 15  # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°
          docker-compose exec -T api-server npx prisma migrate deploy || echo "Migration may have failed, but continuing..."
          
          # nginx-proxy ì„¤ì • ì—…ë°ì´íŠ¸ ë° ì¬ì‹œì‘
          echo "ğŸ”§ Updating nginx configuration..."
          cd ~/nginx-proxy
          
          # growpromise.conf ìƒì„± (ì—†ëŠ” ê²½ìš°)
          if [ ! -f "conf.d/growpromise.conf" ]; then
            echo "Creating nginx configuration..."
            cat > conf.d/growpromise.conf << 'NGINXEOF'
          server {
              listen 3030;
              server_name _;
              
              add_header Access-Control-Allow-Origin * always;
              add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
              add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
              
              location / {
                  if ($$request_method = 'OPTIONS') {
                      return 204;
                  }
                  proxy_pass http://api-server-growpromise:3000;
                  proxy_set_header Host $$host;
                  proxy_set_header X-Real-IP $$remote_addr;
                  client_max_body_size 50M;
              }
          }
          NGINXEOF
          fi
          
          # nginx-proxy ì¬ì‹œì‘
          docker-compose restart nginx-proxy 2>/dev/null || echo "nginx-proxy not running"
          
          # í—¬ìŠ¤ì²´í¬
          echo "ğŸ¥ Performing health check..."
          cd ~/${{ env.PROJECT_NAME }}
          sleep 30
          
          # í—¬ìŠ¤ì²´í¬ ì‹œë„
          for i in {1..5}; do
            if docker-compose exec -T api-server curl -f http://localhost:3000/health; then
              echo "âœ… Health check passed!"
              break
            else
              echo "âŒ Health check attempt $i failed, retrying..."
              sleep 10
            fi
          done
          
          # ì •ë¦¬
          echo "ğŸ§¹ Cleaning up..."
          docker system prune -f
          
          echo "ğŸ‰ Deployment completed!"
          echo "ğŸ“± GrowPromise API is available at: http://${{ secrets.EC2_HOST }}:3030"

  notify:
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notify deployment result
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… GrowPromise deployment successful!"
        else
          echo "âŒ GrowPromise deployment failed!"
          exit 1
        fi
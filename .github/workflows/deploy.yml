name: Deploy GrowPromise API

on:
  push:
    branches: [ main ]
    paths:
      - 'api-server/**'
      - 'docker-compose.yml'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]

env:
  PROJECT_NAME: growpromise-project

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: api-server/package-lock.json
    
    - name: Install dependencies
      working-directory: ./api-server
      run: npm ci
    
    - name: Generate Prisma client
      working-directory: ./api-server
      run: npx prisma generate
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
    
    - name: Run database migrations
      working-directory: ./api-server
      run: npx prisma migrate deploy
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
    
    - name: Run tests
      working-directory: ./api-server
      run: npm test
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        JWT_SECRET: test-secret-for-ci

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        port: 22
        script: |
          echo "ğŸš€ Starting deployment..."
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì´ë™/ìƒì„±
          cd ~ && mkdir -p ${{ env.PROJECT_NAME }}
          cd ${{ env.PROJECT_NAME }}
          
          # Git ì €ì¥ì†Œ ì´ˆê¸°í™” ë˜ëŠ” ì—…ë°ì´íŠ¸
          if [ ! -d ".git" ]; then
            echo "ğŸ“¥ Cloning repository..."
            git clone ${{ github.server_url }}/${{ github.repository }} .
          else
            echo "ğŸ”„ Updating repository..."
            git fetch origin
            git reset --hard origin/main
          fi
          
          # Docker ë„¤íŠ¸ì›Œí¬ ìƒì„± (ì—†ìœ¼ë©´)
          docker network create growpromise-network 2>/dev/null || echo "Network already exists"
          
          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± (ìˆ˜ì •ëœ ë¶€ë¶„)
          echo "âš™ï¸ Creating production environment file..."
          cat > .env << 'EOF'
          # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° (AWS RDS)
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          
          # JWT ì„¤ì •
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          
          # ì„œë²„ ì„¤ì •
          NODE_ENV=production
          PORT=3000
          UPLOAD_DIR=uploads
          
          # AWS S3 ì„¤ì •
          S3_REGION=${{ secrets.S3_REGION }}
          S3_ACCESS_KEY=${{ secrets.S3_ACCESS_KEY }}
          S3_SECRET_KEY=${{ secrets.S3_SECRET_KEY }}
          S3_BUCKET=${{ secrets.S3_BUCKET }}
          
          # Google OAuth
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          EOF
          
          # íŒŒì¼ ê¶Œí•œ ì„¤ì • (ë³´ì•ˆ)
          chmod 600 .env
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
          echo "ğŸ”„ Stopping existing containers..."
          docker-compose down --remove-orphans 2>/dev/null || true
          
          # ìƒˆ ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì‹œì‘
          echo "ğŸ—ï¸ Building and starting containers..."
          docker-compose up -d --build
          
          # ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ (AWS RDSì— ëŒ€í•´)
          echo "ğŸ—„ï¸ Running database migrations..."
          sleep 15  # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°
          docker-compose exec -T api-server npx prisma migrate deploy || echo "Migration may have failed, but continuing..."
          
          # nginx-proxy ì„¤ì • ì—…ë°ì´íŠ¸
          echo "ğŸ”§ Updating nginx configuration..."
          cd ~/nginx-proxy
          
          # growpromise.conf ìƒì„± (ì—†ëŠ” ê²½ìš°)
          if [ ! -f "conf.d/growpromise.conf" ]; then
            echo "Creating nginx configuration..."
            cat > conf.d/growpromise.conf << 'NGINXEOF'
          server {
              listen 3030;
              server_name _;
              
              # CORS ì„¤ì •
              add_header Access-Control-Allow-Origin * always;
              add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
              add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
              add_header Access-Control-Max-Age 86400 always;
              
              location / {
                  # OPTIONS ìš”ì²­ ì²˜ë¦¬
                  if ($$request_method = 'OPTIONS') {
                      add_header Access-Control-Allow-Origin * always;
                      add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
                      add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
                      add_header Access-Control-Max-Age 86400 always;
                      add_header Content-Length 0;
                      add_header Content-Type text/plain;
                      return 204;
                  }
                  
                  proxy_pass http://api-server-growpromise:3000;
                  proxy_set_header Host $$host;
                  proxy_set_header X-Real-IP $$remote_addr;
                  proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $$scheme;
                  
                  # íƒ€ì„ì•„ì›ƒ ì„¤ì •
                  proxy_connect_timeout 60s;
                  proxy_send_timeout 60s;
                  proxy_read_timeout 60s;
                  
                  # ì—…ë¡œë“œ íŒŒì¼ í¬ê¸° ì œí•œ
                  client_max_body_size 50M;
              }
              
              # í—¬ìŠ¤ì²´í¬
              location /health {
                  proxy_pass http://api-server-growpromise:3000/health;
                  access_log off;
              }
          }
          NGINXEOF
          fi
          
          # nginx-proxy docker-compose.yml ì—…ë°ì´íŠ¸ (growpromise-network ì¶”ê°€)
          if ! grep -q "growpromise-network" docker-compose.yml; then
            echo "Adding growpromise network to nginx-proxy..."
            # ë°±ì—…
            cp docker-compose.yml docker-compose.yml.backup
            
            # networks ì„¹ì…˜ì— growpromise-network ì¶”ê°€
            sed -i '/- kidsbugs-network/a \      - growpromise-network' docker-compose.yml
            sed -i '/kidsbugs-network:/a \  growpromise-network:\n    external: true' docker-compose.yml
          fi
          
          # nginx-proxy ì¬ì‹œì‘
          docker-compose restart nginx-proxy 2>/dev/null || echo "nginx-proxy restart failed"
          
          # growpromise ë„¤íŠ¸ì›Œí¬ì— nginx-proxy ì—°ê²°
          docker network connect growpromise-network nginx-proxy 2>/dev/null || echo "Already connected to network"
          
          # í—¬ìŠ¤ì²´í¬
          echo "ğŸ¥ Performing health check..."
          cd ~/${{ env.PROJECT_NAME }}
          sleep 30
          
          # í—¬ìŠ¤ì²´í¬ ì‹œë„ (ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ)
          for i in {1..5}; do
            if docker-compose exec -T api-server curl -f http://localhost:3000/health; then
              echo "âœ… Health check passed!"
              break
            else
              echo "âŒ Health check attempt $i failed, retrying..."
              sleep 10
            fi
          done
          
          # ì™¸ë¶€ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
          echo "ğŸŒ Testing external access..."
          if curl -f http://localhost:3030/health; then
            echo "âœ… External access working!"
          else
            echo "âš ï¸ External access may need more time..."
          fi
          
          # ì •ë¦¬
          echo "ğŸ§¹ Cleaning up..."
          docker system prune -f
          
          echo "ğŸ‰ Deployment completed!"
          echo "ğŸ“± GrowPromise API is available at: http://${{ secrets.EC2_HOST }}:3030"

  notify:
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notify deployment result
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… GrowPromise deployment successful!"
          echo "ğŸŒ API URL: http://${{ secrets.EC2_HOST }}:3030"
        else
          echo "âŒ GrowPromise deployment failed!"
          exit 1
        fi